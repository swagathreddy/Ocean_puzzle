<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Ocean Puzzle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Calibri, Arial, sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        body {
            background-color: #a3e0e9;
            height: 100%;
            min-height: 100vh;
            padding: 10px;
        }

        /* Main container for responsive layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Top Bar for Start Button and Title */
        .top-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        h1 {
            color: #1a365d;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }

        .start-button-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            z-index: 20;
        }

        .start-circle {
            width: 50px;
            height: 50px;
            background-color: #3e8e41;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }

        .start-text {
            background-color: #4CAF50;
            padding: 8px 15px;
            color: white;
            font-weight: bold;
            margin-left: -15px;
            border-radius: 0 5px 5px 0;
        }

        /* Main Layout using Flexbox for responsiveness */
        .main-wrapper {
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap on smaller screens */
            gap: 20px;
            width: 100%;
        }
        
        /* Game Area - contains latitudes and dashboard */
        .game-area {
            flex: 3; /* Takes up more space */
            min-width: 300px; /* Minimum width before wrapping */
            display: flex;
        }

         .latitude-column {
            flex-basis: 120px;
            position: relative; /* Use as positioning context */
            padding-right: 10px;
            text-align: right;
        }


        
        .latitude-label {
            color: #1a365d;
            font-weight: bold;
            font-size: clamp(8px, 2.5vw, 12px);
            position: absolute;
            width: 100%;
            right: 10px;
            transform: translateY(-50%);
            line-height: 1.2;
        }

        /* Base positions for labels (for desktop) */
        .latitude-label:nth-child(1) { top: 14.4%; }
        .latitude-label:nth-child(2) { top: 33.6%; }
        .latitude-label:nth-child(3) { top: 42%; }
        .latitude-label:nth-child(4) { top: 52.6%; }
        .latitude-label:nth-child(5) { top: 72.3%; }

        .dashboard-area {
            flex: 1; /* Takes remaining space in game-area */
            width: 100%;
        }

        .dashboard {
            width: 100%;
            aspect-ratio: 700 / 474; /* Maintain aspect ratio */
            background: url('https://zooreach.org/downloads/1ocean_platform/p1_puzzle/Dashboard.png') no-repeat center center;
            background-size: contain;
            border: 5px solid #f2d675;
            border-radius: 5px;
            position: relative;
        }

        .latitude-lines-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none; 
        }

        .latitude-lines-overlay .line {
            position: absolute;
            width: 100%;
            left: 0;
            border-top: 2px dashed rgba(255, 255, 255, 0.7);
            box-sizing: border-box;
        }
        
        .latitude-lines-overlay .line:nth-child(1) { top: 18.4%; }
        .latitude-lines-overlay .line:nth-child(2) { top: 41.6%; }
        .latitude-lines-overlay .line:nth-child(3) { top: 50%; }  
        .latitude-lines-overlay .line:nth-child(4) { top: 58.6%; }
        .latitude-lines-overlay .line:nth-child(5) { top: 82.3%; }
 

        /* Hint Buttons */
        .hint-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }

        .hint-button {
            background-color: #c8ffe3;
            border: 1px solid #9be9c7;
            padding: 8px;
            cursor: pointer;
            font-size: clamp(10px, 2vw, 14px);
            font-weight: bold;
        }

        /* Side Info Panels and Controls */
        .side-panel {
            flex: 1; /* Takes up less space */
            min-width: 250px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .info-panel, .clues-panel { background-color: white; border-radius: 10px; padding: 10px; display: flex; align-items: flex-start;}
        .info-number { width: 25px; height: 25px; border-radius: 50%; background-color: #ff9090; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .info-content { font-size: 12px; line-height: 1.4; }
        
        .clues-panel { display: block; } 
        .clues-panel h3 { font-size: 14px; margin-bottom: 8px; color: #1a365d;}
        .clues-panel ul { list-style: none; padding-left: 5px; }
        .clues-panel li { font-size: 11px; margin-bottom: 5px; display: flex; align-items: center; }
        .clues-panel li img { width: 16px; height: 16px; margin-right: 8px; object-fit: contain; }


        .control-buttons { display: flex; flex-direction: column; width: 100%; gap: 5px; margin-top: auto; }
        .reset-btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; text-align: center; background-color: #e74c3c;}


        /* Pieces Container */
        .pieces-container-wrapper {
            width: 100%;
            margin-top: 15px;
            background-color: #f2d675;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            min-height: 60px;
        }

        .puzzle-piece {
            position: relative;
            width: 60px;
            height: 45px;
            cursor: grab;
            touch-action: none;
            transition: transform 0.2s;
        }
        .puzzle-piece.dragging { cursor: grabbing; }

        .puzzle-piece img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .dashboard .puzzle-piece {
            position: absolute !important;
            width: auto;
            height: auto;
            background: none !important;
            cursor: pointer;
            z-index: 2;
        }

        .dashboard .puzzle-piece.dragging {
             opacity: 0.8;
             transform-origin: center center;
             z-index: 1000;
        }
        
        .dashboard .puzzle-piece.snapped {
             pointer-events: none;
             z-index: 1;
        }

        .correct-flash {
            animation: flash-green 1.5s ease-out;
        }
        @keyframes flash-green {
            0% { box-shadow: 0 0 25px 15px rgba(76, 175, 80, 0.7); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .reference-image-container { margin-top: 10px; }
        .reference-image-container img {
            width: 100%;
            border-radius: 5px;
            border: 2px solid #f2d675;
            cursor: pointer;
        }
        
        .references-section { margin-top: 20px; width: 100%; text-align: center;}
        .references-title { font-weight: bold; margin-bottom: 5px; }
        .references-content { font-size: 12px; font-style: italic; text-align: left; }

        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 20px;}
        @keyframes modalAppear { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Generic modal content for hint/ref popups */
        .modal-content { background: white; padding: 20px 30px; border-radius: 15px; text-align: center; max-width: 90%; animation: modalAppear 0.3s ease-out; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .modal-content p { font-size: 14px; line-height: 1.5; margin-bottom: 20px; text-align: left; }
        .modal-content button.close-button { display: block; margin: 10px auto 0; padding: 8px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .ref-modal .modal-content { width: auto; max-width: 600px; }
        .ref-modal img { max-width: 100%; height: auto; }

        /* --- NEW: END GAME MODAL LAYOUT --- */
        .end-game-layout {
            position: relative; /* Needed for positioning the close button */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, auto);
            gap: 20px;
            width: 100%;
            max-width: 1100px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            animation: modalAppear 0.4s ease-out;
        }

        /* NEW: Close button for end-game modal */
        .end-game-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            color: #555;
            font-size: 24px;
            font-weight: bold;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }
        .end-game-close-btn:hover {
            background-color: #e74c3c;
            color: white;
            transform: scale(1.1);
        }

        .congrats-message {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            background-color: #e3f2fd;
            border: 2px solid #90caf9;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .congrats-message h2 { color: #1976d2; font-size: 2em; margin-bottom: 15px; }
        .congrats-message p { color: #424242; font-size: 1em; text-align: center; margin-bottom: 20px; }
        .congrats-message button { background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
        .congrats-message button:hover { background: #45a049; }

        .hint-item {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #c8e6c9;
        }
        .hint-item h3 { color: #2e7d32; font-size: 1.1em; margin-bottom: 8px; border-bottom: 1px solid #a5d6a7; padding-bottom: 5px;}
        .hint-item p { color: #333; font-size: 0.9em; line-height: 1.5; margin: 0; }

        .hint-1 { grid-area: 1 / 1; }
        .hint-2 { grid-area: 1 / 2; }
        .hint-3 { grid-area: 1 / 3; }
        .hint-4 { grid-area: 2 / 1; }
        .hint-5 { grid-area: 2 / 3; }
        .hint-6 { grid-area: 3 / 2; }


        /* =========== MOBILE & RESPONSIVE STYLES =========== */
        @media (max-width: 900px) {
             /* Switch End Game Modal to vertical layout */
            .end-game-layout {
                display: flex;
                flex-direction: column;
                max-width: 500px;
                max-height: 90vh;
                overflow-y: auto;
                padding-top: 45px; /* Add padding to avoid overlap with close button */
            }
            .congrats-message { order: 1; }
            .hint-item { order: 2; }
        }

        @media (max-width: 850px) {
            .main-wrapper { flex-direction: column; }
            .side-panel { order: 1; width: 100%; flex-direction: column; }
            .info-content { font-size: 11px; }
            .control-buttons, .reference-image-container { margin-top: 10px; }
            .game-area { order: 2; width: 100%; }
            
            .latitude-column {
                flex-basis: 20%;
                padding: 0 5px 0 0;
            }

            .latitude-label {
                right: 5px;
                font-size: 8px; 
            }
            .latitude-label:nth-child(1) { top: 12.4%; }
            .latitude-label:nth-child(2) { top: 27%; }
            .latitude-label:nth-child(3) { top: 35.5%; }
            .latitude-label:nth-child(4) { top: 46%; }
            .latitude-label:nth-child(5) { top: 62%; }

            .dashboard-area {
                flex-basis: 80%; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="start-button-container" id="startButton">
                <div class="start-circle">5</div>
                <div class="start-text">Start</div>
            </div>
            <h1>One Ocean Puzzle</h1>
        </div>

        <div class="main-wrapper">
            <div class="game-area">
                <div class="latitude-column">
                    <div class="latitude-label">ARCTIC CIRCLE</div>
                    <div class="latitude-label">TROPIC OF CANCER</div>
                    <div class="latitude-label">EQUATOR</div>
                    <div class="latitude-label">TROPIC OF CAPRICORN</div>
                    <div class="latitude-label">ANTARCTIC CIRCLE</div>
                </div>
                <div class="dashboard-area">
                    <div class="dashboard" id="puzzleBoard">
                         <div class="latitude-lines-overlay">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <div class="hint-buttons">
                        <button class="hint-button" data-hint="1">HINT 1</button>
                        <button class="hint-button" data-hint="2">HINT 2</button>
                        <button class="hint-button" data-hint="3">HINT 3</button>
                        <button class="hint-button" data-hint="4">HINT 4</button>
                        <button class="hint-button" data-hint="5">HINT 5</button>
                        <button class="hint-button" data-hint="6">HINT 6</button>
                    </div>
                </div>
            </div>
            <div class="side-panel">
                <div class="info-panel">
                    <div class="info-number">1</div>
                    <div class="info-content">There are 12 ocean-shaped pieces (not continents!). The puzzle includes pieces for the Arctic, Southern, Indian, Atlantic (3), and Pacific (6) oceans.</div>
                </div>
                <div class="info-panel">
                    <div class="info-number">2</div>
                    <div class="info-content">Drag the pieces to their correct positions on the 2D map. An illustration of the completed puzzle is available for your reference.</div>
                </div>
                 <div class="info-panel">
                    <div class="info-number">3</div>
                    <div class="info-content">When a piece is placed in the correct spot, it will light up and lock into place.</div>
                </div>
                 <div class="clues-panel">
                    <h3>Hints to Watch for:</h3>
                    <ul>
                        <li><img src="./whale.png" alt="Whale icon">Populations and migration routes of Humpback whales</li>
                        <li><img src="./arctic.png" alt="Tern icon">Arctic terns</li>
                        <li><img src="./turtle.png" alt="Turtle icon">Leatherback turtles</li>
                        <li><img src="./conveyer.png" alt="Current icon">The Great Ocean Conveyor Belt, represented by blue and red lines with arrows across puzzle pieces.</li>
                    </ul>
                </div>
                <div class="reference-image-container">
                    <img src="./Main.png" alt="Reference Map" id="refImage">
                </div>
                <div class="control-buttons">
                    <button class="reset-btn" id="resetBtn">Reset Puzzle</button>
                </div>
            </div>
        </div>

        <div class="pieces-container-wrapper" id="piecesContainer"></div>
        
        <div class="references-section">
            <div class="references-title">REFERENCES:</div>
            <div class="references-content">
                1. Global Conveyor Belt: Broecker, W.S. (1991) | 2. Humpback Whale Migration: Rasmussen, K., et al. (2007) | 3. Arctic Tern Migration: Egevang, C., et al. (2010) | 4. Leatherback Turtle Migration: Bailey, H., et al. (2012) | 5. Ocean Temperature: Levitus, S., et al. (2012).
            </div>
        </div>
        
        <div class="modal" id="endGameModal">
            <div class="end-game-layout">
                <button class="end-game-close-btn" id="endGameCloseBtn">&times;</button>
                <div class="hint-item hint-1">
                    <h3>HINT 1</h3>
                    <p>The oceans are hottest at the equator (redder regions) and coolest near the poles (bluer regions). Match the puzzle piece colors to the dashboard background!</p>
                </div>
                <div class="hint-item hint-2">
                    <h3>HINT 2</h3>
                    <p>The Global Conveyor Belt is the longest deep-sea current that connects all oceans. Connect the red (warm) and blue (cold) lines to form the current.</p>
                </div>
                <div class="hint-item hint-3">
                    <h3>HINT 3</h3>
                    <p>Humpback whales migrate from polar feeding grounds in the summer to equatorial breeding grounds in the winter. Follow their path on the pieces!</p>
                </div>
                <div class="hint-item hint-4">
                    <h3>HINT 4</h3>
                    <p>Arctic Terns make the longest migration, traveling from the Arctic all the way to the Antarctic and back. Connect their flight path across the globe!</p>
                </div>
                <div class="congrats-message">
                    <h2>Congratulations! 🎉</h2>
                    <p>You have completed the puzzle. You can now see how the Great Ocean Conveyor Belt and major migration routes connect our One Ocean!</p>
                    <button id="playAgainBtn">Play Again</button>
                </div>
                <div class="hint-item hint-5">
                    <h3>HINT 5</h3>
                    <p>Leatherback turtles travel across the vast Pacific Ocean between foraging grounds. Connect their paths, remembering the Pacific is on both sides of a 2D map!</p>
                </div>
                <div class="hint-item hint-6">
                    <h3>HINT 6</h3>
                    <p>Bonus Clue: As you align the oceans, the shapes of the continents emerge in the negative space, helping you verify the piece placements!</p>
                </div>
            </div>
        </div>
        
        <div class="modal" id="hintModal">
            <div class="modal-content">
                <h3 id="hintTitle"></h3>
                <p id="hintBody"></p>
                <button class="close-button">Close</button>
            </div>
        </div>
        
        <div class="modal ref-modal" id="refModal">
            <div class="modal-content">
                <img src="https://i.imgur.com/8a55427.png" alt="Full Reference Map">
                <button class="close-button">Close</button>
            </div>
        </div>
    </div>

    <script>
    const game = {
        pieces: [
             { id: "arctic", name: "Arctic Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/ARCTIC.png", position: { x: 0.4, y: 1 }, size: { width: 99.1, height: 29.5 }, correctRotation: 0 },
             { id: "northPacific", name: "North Pacific Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/NORTH%20PACIFIC.png", position: { x: 0.7, y: 16.2 }, size: { width: 16.8, height: 32.9 }, correctRotation: 0 },
             { id: "northPacific2", name: "North Pacific Ocean 2", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/NORTH%20PACIFIC%202.png", position: { x: 78.0, y: 18.2 }, size: { width: 21.6, height: 24.9 }, correctRotation: 0 },
             { id: "tropicalPacific1", name: "Tropical Pacific 1", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/TROPICAL%20PACIFIC%201.png", position: { x: 0.7, y: 36.5 }, size: { width: 27.0, height: 29.5 }, correctRotation: 0 },
             { id: "tropicalPacific2", name: "Tropical Pacific 2", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/TROPICAL%20PACIFIC%202.png", position: { x: 73.1, y: 39.1 }, size: { width: 26.3, height: 26.0 }, correctRotation: 0 },
             { id: "southPacific", name: "South Pacific Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/SOUTH%20PACIFIC.png", position: { x: 0.7, y: 52.3 }, size: { width: 28.4, height: 34.2 }, correctRotation: 0 },
             { id: "southPacific2", name: "South Pacific Ocean 2", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/SOUTH%20PACIFIC%202.png", position: { x: 84.1, y: 64.3 }, size: { width: 15.4, height: 21.1 }, correctRotation: 0 },
             { id: "northAtlantic", name: "North Atlantic Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/NORTH%20ATLANTIC.png", position: { x: 25.6, y: 10 }, size: { width: 38.4, height: 33.1 }, correctRotation: 0 },
             { id: "tropicalAtlantic", name: "Tropical Atlantic Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/TROPICAL%20ATLANTIC.png", position: { x: 20.3, y: 34.5 }, size: { width: 31.1, height: 29.7 }, correctRotation: 0 },
             { id: "southAtlantic", name: "South Atlantic Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/SOUTH%20ATLANTIC.png", position: { x: 28, y: 57.2 }, size: { width: 25.6, height: 24.9 }, correctRotation: 0 },
             { id: "indianOcean", name: "Indian Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/INDIAN%20OCEAN.png", position: { x: 53.4, y: 38.4 }, size: { width: 32.1, height: 43.2 }, correctRotation: 0 },
             { id: "southernOcean", name: "Southern Ocean", image: "https://zooreach.org/downloads/1ocean_platform/p1_puzzle/SOUTHERN%20OCEAN.png", position: { x: 0.4, y: 78.3 }, size: { width: 99.0, height: 21.5 }, correctRotation: 0 }
        ],
        hints: [
             { title: "HINT 1", content: "The oceans are hottest at the equator (redder regions) and coolest near the poles (bluer regions). Match the puzzle piece colors to the dashboard background!" },
             { title: "HINT 2", content: "The Global Conveyor Belt is the longest deep-sea current that connects all oceans. Connect the red (warm) and blue (cold) lines to form the current." },
             { title: "HINT 3", content: "Humpback whales migrate from polar feeding grounds in the summer to equatorial breeding grounds in the winter. Follow their path on the pieces!" },
             { title: "HINT 4", content: "Arctic Terns make the longest migration, traveling from the Arctic all the way to the Antarctic and back. Connect their flight path across the globe!" },
             { title: "HINT 5", content: "Leatherback turtles travel across the vast Pacific Ocean between foraging grounds. Connect their paths, remembering the Pacific is on both sides of a 2D map!" },
             { title: "HINT 6", content: "Bonus Clue: As you start aligning the oceans correctly, you will notice that the shapes of the main continents slowly emerge in the background of the map. This will help you double-check the placement as the puzzle progresses!" }
        ],
        currentRotations: {},
        draggedPiece: null,
        dragOffset: { x: 0, y: 0 },
        isDragging: false,

        init() {
            this.setupDOM();
            this.createPieces();
            this.setupEventListeners();
            this.resetRotations();
        },

        setupDOM() {
            this.elements = {
                board: document.getElementById("puzzleBoard"),
                piecesContainer: document.getElementById("piecesContainer"),
                resetBtn: document.getElementById("resetBtn"),
                hintModal: document.getElementById('hintModal'),
                hintTitle: document.getElementById('hintTitle'),
                hintBody: document.getElementById('hintBody'),
                endGameModal: document.getElementById("endGameModal"),
                endGameCloseBtn: document.getElementById("endGameCloseBtn"),
                playAgainBtn: document.getElementById("playAgainBtn"),
                refImage: document.getElementById("refImage"),
                refModal: document.getElementById("refModal"),
            };
        },

        createPieces() {
            this.elements.piecesContainer.innerHTML = "";
            this.pieces.forEach(piece => {
                const div = document.createElement("div");
                div.className = "puzzle-piece";
                div.dataset.id = piece.id;
                const img = document.createElement("img");
                img.src = piece.image;
                img.alt = piece.name;
                div.appendChild(img);
                this.elements.piecesContainer.appendChild(div);
            });
        },
        
        resetRotations() {
            this.currentRotations = {};
            this.pieces.forEach(p => this.currentRotations[p.id] = 0);
        },

        setupEventListeners() {
            this.elements.resetBtn.addEventListener("click", () => this.resetPuzzle());
            this.elements.playAgainBtn.addEventListener("click", () => this.resetPuzzle());
            document.querySelectorAll('.hint-button').forEach(btn => btn.addEventListener('click', (e) => this.showHint(e)));
            
            this.elements.endGameCloseBtn?.addEventListener('click', () => {
                this.elements.endGameModal.style.display = 'none';
            });

            document.querySelectorAll('.close-button').forEach(btn => btn.addEventListener('click', () => {
                this.elements.hintModal.style.display = 'none';
                this.elements.refModal.style.display = 'none';
            }));

            this.elements.refImage.addEventListener('click', () => {
                this.elements.refModal.style.display = 'flex';
            });
            
            document.addEventListener('mousedown', (e) => this.dragStart(e));
            document.addEventListener('touchstart', (e) => this.dragStart(e));
            document.addEventListener('mousemove', (e) => this.dragMove(e));
            document.addEventListener('touchmove', (e) => this.dragMove(e), { passive: false });
            document.addEventListener('mouseup', (e) => this.dragEnd(e));
            document.addEventListener('touchend', (e) => this.dragEnd(e));
            document.addEventListener('click', (e) => this.handleTap(e));
        },

        dragStart(e) {
            const piece = e.target.closest('.puzzle-piece');
            if (!piece || piece.classList.contains('snapped')) return;
            
            this.draggedPiece = piece;
            this.isDragging = true;
            this.draggedPiece.classList.add('dragging');

            const boardRect = this.elements.board.getBoundingClientRect();
            const eventPos = e.touches ? e.touches[0] : e;

            if (!this.draggedPiece.parentElement.classList.contains('dashboard')) {
                const pieceData = this.getPieceData(this.draggedPiece.dataset.id);
                this.elements.board.appendChild(this.draggedPiece);
                this.draggedPiece.style.width = `${pieceData.size.width}%`;
                this.draggedPiece.style.height = `${pieceData.size.height}%`;
                this.draggedPiece.style.left = `${(eventPos.clientX - boardRect.left) / boardRect.width * 100 - pieceData.size.width / 2}%`;
                this.draggedPiece.style.top = `${(eventPos.clientY - boardRect.top) / boardRect.height * 100 - pieceData.size.height / 2}%`;
            }
            
            const newPieceRect = this.draggedPiece.getBoundingClientRect();
            this.dragOffset = {
                x: eventPos.clientX - newPieceRect.left,
                y: eventPos.clientY - newPieceRect.top
            };
        },

        dragMove(e) {
            if (!this.draggedPiece || !this.isDragging) return;
            e.preventDefault();

            const boardRect = this.elements.board.getBoundingClientRect();
            const eventPos = e.touches ? e.touches[0] : e;
            
            this.draggedPiece.style.left = `${(eventPos.clientX - boardRect.left - this.dragOffset.x) / boardRect.width * 100}%`;
            this.draggedPiece.style.top = `${(eventPos.clientY - boardRect.top - this.dragOffset.y) / boardRect.height * 100}%`;
        },

        dragEnd(e) {
            if (!this.draggedPiece) return;
            const boardRect = this.elements.board.getBoundingClientRect();
            const eventPos = e.changedTouches ? e.changedTouches[0] : e;
            const isOutside = eventPos.clientX < boardRect.left || eventPos.clientX > boardRect.right ||
                                eventPos.clientY < boardRect.top || eventPos.clientY > boardRect.bottom;
            if (isOutside) {
                this.returnPieceToContainer(this.draggedPiece);
            } else {
                this.snapPiece(this.draggedPiece);
            }
            this.draggedPiece.classList.remove('dragging');
            this.draggedPiece = null;
            setTimeout(() => { this.isDragging = false; }, 50);
        },

        returnPieceToContainer(piece) {
            piece.style.cssText = ''; 
            const pieceId = piece.dataset.id;
            this.currentRotations[pieceId] = 0; 
            this.elements.piecesContainer.appendChild(piece);
        },

        handleTap(e) {
            if (this.isDragging) return;
            const piece = e.target.closest('.puzzle-piece');
            if (piece && piece.parentElement.classList.contains('dashboard') && !piece.classList.contains('snapped')) {
                this.rotatePiece(piece);
            }
        },
        
        rotatePiece(piece) {
            const pieceId = piece.dataset.id;
            this.currentRotations[pieceId] = (this.currentRotations[pieceId] + 90) % 360;
            piece.style.transform = `rotate(${this.currentRotations[pieceId]}deg)`;
            this.snapPiece(piece);
        },

        snapPiece(piece) {
            const pieceId = piece.dataset.id;
            const pieceData = this.getPieceData(pieceId);
            const currentX = parseFloat(piece.style.left);
            const currentY = parseFloat(piece.style.top);
            const targetX = pieceData.position.x;
            const targetY = pieceData.position.y;
            const dx = currentX - targetX;
            const dy = currentY - targetY;
            const distance = Math.sqrt(dx*dx + dy*dy);
            const snapThreshold = 5; 
            if (distance < snapThreshold && this.currentRotations[pieceId] === pieceData.correctRotation) {
                piece.style.left = `${targetX}%`;
                piece.style.top = `${targetY}%`;
                piece.classList.add('snapped', 'correct-flash');
                setTimeout(() => piece.classList.remove('correct-flash'), 1500); 
                this.checkCompletion();
            }
        },
        
        getPieceData: id => game.pieces.find(p => p.id === id),
        
        checkCompletion() {
            const snappedPieces = this.elements.board.querySelectorAll(".snapped");
            if (snappedPieces.length === this.pieces.length) {
                this.elements.endGameModal.style.display = "flex";
            }
        },

        resetPuzzle() {
            const boardPieces = this.elements.board.querySelectorAll('.puzzle-piece');
            boardPieces.forEach(piece => {
                piece.classList.remove('snapped');
                this.returnPieceToContainer(piece)
            });
            this.elements.endGameModal.style.display = "none";
        },

        showHint(e) {
            const hintIndex = parseInt(e.target.dataset.hint) - 1;
            this.elements.hintTitle.textContent = this.hints[hintIndex].title;
            this.elements.hintBody.textContent = this.hints[hintIndex].content;
            this.elements.hintModal.style.display = 'flex';
        }
    };

    window.addEventListener('load', () => game.init());
    </script>
</body>
</html>
